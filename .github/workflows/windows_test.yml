name: Windows Smoke Test & Unit Test

on:
  push:
    branches:
      - '**'
    tags:
      - 'v*'
    paths:
      - 'bin/**'
      - 'tests/**'
      - '.github/workflows/windows_test.yml'
  pull_request:
    paths:
      - 'bin/**'
      - 'tests/**'
      - '.github/workflows/windows_test.yml'

jobs:
  test:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v6

      - name: Free Disk Space (Windows)
        run: |
          Write-Host "Cleaning up disk space..."
          if (Test-Path "C:\Android") { Remove-Item -Recurse -Force "C:\Android" -ErrorAction SilentlyContinue }
          Get-PSDrive C | Select-Object Used,Free

      - name: Setup Environment & FW Cache
        uses: ./.github/actions/setup-fw-env
        with:
          fw-password: ${{ secrets.TEST_FW_PASSWORD }}

      - name: Smoke Test (Compile)
        run: |
          python -m compileall bin/ltbox

      - name: Run Unit Tests
        env:
          TEST_FW_URL: ${{ secrets.TEST_FW_URL }}
          TEST_FW_PASSWORD: ${{ secrets.TEST_FW_PASSWORD }}
          PYTHONUNBUFFERED: "1"
          PYTHONPATH: "bin"
        run: |
          pytest -s tests/ -m "not integration" --cov=bin/ltbox --cov-report=term-missing

      - name: Run Integration Tests
        env:
          TEST_FW_URL: ${{ secrets.TEST_FW_URL }}
          TEST_FW_PASSWORD: ${{ secrets.TEST_FW_PASSWORD }}
          PYTHONUNBUFFERED: "1"
          PYTHONPATH: "bin"
        run: |
          pytest -s tests/ -m integration --run-integration --cov=bin/ltbox --cov-report=term-missing --cov-append
